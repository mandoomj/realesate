<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>우리 동네 아파트 실거래가 대시보드</title>
    <!-- Tailwind CSS (디자인용) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js (차트용) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap');
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #fff5f8;
        }
        .magenta-theme-bg { background-color: #e91e63; }
        .magenta-theme-text { color: #e91e63; }
        .magenta-theme-border { border-color: #e91e63; }
        .card { background: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(233, 30, 99, 0.1); }
        .loading-spinner {
            border: 4px solid rgba(233, 30, 99, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #e91e63;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <!-- 헤더 -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold magenta-theme-text mb-2">우리 동네 아파트 실거래가 대시보드</h1>
            <p class="text-gray-600">최신 거래 데이터를 기반으로 한 실시간 정보 분석</p>
        </header>

        <!-- 로딩 표시 -->
        <div id="loading" class="flex flex-col items-center justify-center py-20">
            <div class="loading-spinner mb-4"></div>
            <p class="magenta-theme-text font-medium">데이터를 불러오는 중입니다...</p>
        </div>

        <!-- 메인 콘텐츠 (데이터 로드 후 표시) -->
        <div id="content" class="hidden">
            <!-- 법정동 필터 섹션 추가 -->
            <div class="flex justify-end mb-4">
                <div class="flex items-center bg-white rounded-lg shadow px-4 py-2 border border-pink-100">
                    <label for="dong-filter" class="mr-3 font-bold text-gray-700">동네(법정동) 선택:</label>
                    <select id="dong-filter" class="border-gray-300 rounded text-gray-700 focus:ring-pink-500 focus:border-pink-500 p-1 font-medium cursor-pointer outline-none">
                        <option value="전체">전체</option>
                        <!-- 자바스크립트에서 옵션 자동 추가 -->
                    </select>
                </div>
            </div>

            <!-- 요약 통계 카드 -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="card p-6 text-center">
                    <p class="text-sm text-gray-500 mb-1">전체 거래 건수</p>
                    <p id="stat-total" class="text-2xl font-bold magenta-theme-text">-</p>
                </div>
                <div class="card p-6 text-center border-l-4 magenta-theme-border">
                    <p class="text-sm text-gray-500 mb-1">평균 거래가</p>
                    <p id="stat-avg" class="text-2xl font-bold text-gray-800">-</p>
                </div>
                <div class="card p-6 text-center">
                    <p class="text-sm text-gray-500 mb-1">최고 거래가</p>
                    <p id="stat-max" class="text-2xl font-bold text-red-500">-</p>
                </div>
                <div class="card p-6 text-center">
                    <p class="text-sm text-gray-500 mb-1">최저 거래가</p>
                    <p id="stat-min" class="text-2xl font-bold text-blue-500">-</p>
                </div>
            </div>

            <!-- 차트 섹션 -->
            <div class="card p-6 mb-8">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <span class="w-2 h-6 magenta-theme-bg mr-2 rounded"></span>
                    <span id="chart-title">월별 평균 거래가격 추이 (만원)</span>
                </h2>
                <div class="h-64 md:h-96">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>

            <!-- 상세 거래 목록 테이블 -->
            <div class="card overflow-hidden">
                <div class="p-6 border-b border-pink-100 flex justify-between items-center bg-pink-50">
                    <h2 class="text-xl font-bold">상세 거래 목록</h2>
                    <span id="data-count" class="text-sm magenta-theme-bg text-white px-3 py-1 rounded-full"></span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-50 text-gray-600 text-sm uppercase">
                            <tr>
                                <th class="p-4 font-semibold">거래일자</th>
                                <th class="p-4 font-semibold">아파트명</th>
                                <th class="p-4 font-semibold">법정동</th>
                                <th class="p-4 font-semibold text-right">전용면적(㎡)</th>
                                <th class="p-4 font-semibold text-center">층</th>
                                <th class="p-4 font-semibold text-right">거래금액(만원)</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="text-gray-700 divide-y divide-pink-50">
                            <!-- 데이터 로드 시 행 추가 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 푸터 -->
        <footer class="mt-12 py-6 text-center text-gray-400 text-sm border-t border-pink-200">
            © 2026 with dream consulting. All Rights Reserved.
        </footer>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS4W521ObK0LCqzNI7IhvSwk68S2ZsGsAU-lpmnSKDlM9FymzEXtWQRT63l0oVSsYZi7G0_Uavqcj3P/pub?gid=572123675&single=true&output=csv';

        let globalData = []; // 원본 전체 데이터를 보관할 전역 변수
        let priceChartInstance = null; // 기존 차트를 삭제하고 다시 그리기 위한 변수

        // 금액 포맷팅 (쉼표 추가)
        function formatNumber(num) {
            return Math.floor(num).toLocaleString();
        }

        // CSV 파싱 함수
        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            
            return lines.slice(1).map(line => {
                const values = line.split(',');
                const obj = {};
                headers.forEach((header, i) => {
                    obj[header] = values[i] ? values[i].replace(/"/g, '').trim() : '';
                });
                return obj;
            });
        }

        // 대시보드 렌더링 함수 (필터링 시 재사용)
        function renderDashboard(dataToRender, selectedRegionName = '전체') {
            // 차트 제목 업데이트
            const chartTitle = selectedRegionName === '전체' 
                ? '월별 평균 거래가격 추이 (만원)' 
                : `[${selectedRegionName}] 월별 평균 거래가격 추이 (만원)`;
            document.getElementById('chart-title').innerText = chartTitle;

            // 1. 요약 통계 계산
            const prices = dataToRender.map(d => d.price);
            const totalCount = dataToRender.length;
            const avgPrice = totalCount > 0 ? prices.reduce((a, b) => a + b, 0) / totalCount : 0;
            const maxPrice = totalCount > 0 ? Math.max(...prices) : 0;
            const minPrice = totalCount > 0 ? Math.min(...prices) : 0;

            document.getElementById('stat-total').innerText = `${totalCount}건`;
            document.getElementById('stat-avg').innerText = totalCount > 0 ? `${formatNumber(avgPrice)}만원` : '-';
            document.getElementById('stat-max').innerText = totalCount > 0 ? `${formatNumber(maxPrice)}만원` : '-';
            document.getElementById('stat-min').innerText = totalCount > 0 ? `${formatNumber(minPrice)}만원` : '-';
            document.getElementById('data-count').innerText = `총 ${totalCount}개 데이터`;

            // 2. 월별 평균 데이터 가공 (차트용)
            const monthlyData = {};
            dataToRender.forEach(item => {
                const month = item.date.substring(0, 7); 
                if (!monthlyData[month]) {
                    monthlyData[month] = { sum: 0, count: 0 };
                }
                monthlyData[month].sum += item.price;
                monthlyData[month].count += 1;
            });

            const sortedMonths = Object.keys(monthlyData).sort();
            const chartLabels = sortedMonths;
            const chartValues = sortedMonths.map(m => Math.floor(monthlyData[m].sum / monthlyData[m].count));

            // 기존 차트가 있다면 파기 (Canvas에 덧그려지는 에러 방지)
            if (priceChartInstance) {
                priceChartInstance.destroy();
            }

            // 3. 차트 생성
            const ctx = document.getElementById('priceChart').getContext('2d');
            priceChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: '평균 거래가',
                        data: chartValues,
                        borderColor: '#e91e63',
                        backgroundColor: 'rgba(233, 30, 99, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#e91e63',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: false, grid: { color: '#fce4ec' } },
                        x: { grid: { display: false } }
                    }
                }
            });

            // 4. 테이블 렌더링
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = ''; // 테이블 내용 초기화
            
            if(dataToRender.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-gray-500">선택하신 지역의 거래 데이터가 없습니다.</td></tr>`;
                return;
            }

            dataToRender.forEach((item, index) => {
                const row = document.createElement('tr');
                
                // 짝수/홀수 행 배경색 다르게 (줄무늬 효과) 및 마우스 올리면 배경색 변경
                row.className = index % 2 === 0 
                    ? 'bg-white hover:bg-pink-100 transition-colors' 
                    : 'bg-pink-50/50 hover:bg-pink-100 transition-colors';
                
                // 거래금액 5억(50,000만원) 이상일 경우 빨간색으로 강력하게 강조
                const priceClass = item.price >= 50000 
                    ? 'text-red-600 font-extrabold' 
                    : 'magenta-theme-text font-bold';

                row.innerHTML = `
                    <td class="p-4 text-sm">${item["거래일자"]}</td>
                    <td class="p-4 font-bold text-gray-800">${item["아파트명"]}</td>
                    <td class="p-4 text-sm text-gray-500">${item["법정동"]}</td>
                    <td class="p-4 text-right">${item["전용면적(㎡)"]}</td>
                    <td class="p-4 text-center">${item["층"]}</td>
                    <td class="p-4 text-right ${priceClass}">${formatNumber(item.price)}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // 데이터 처리 및 초기화
        async function initDashboard() {
            try {
                // CSV 데이터 로드
                const response = await fetch(CSV_URL);
                const csvData = await response.text();
                const data = parseCSV(csvData);

                if (data.length === 0) throw new Error("데이터가 없습니다.");

                // 숫자 데이터 전처리 후 전역 변수에 저장 (필터링 기준용)
                globalData = data.map(item => ({
                    ...item,
                    price: parseInt(item["거래금액(만원)"]) || 0,
                    area: parseFloat(item["전용면적(㎡)"]) || 0,
                    date: item["거래일자"]
                })).sort((a, b) => b.date.localeCompare(a.date));

                // 법정동 목록 추출 및 필터 드롭다운 구성
                const dongSet = new Set(globalData.map(item => item["법정동"]));
                const dongArray = Array.from(dongSet).sort();
                const dongFilter = document.getElementById('dong-filter');

                dongArray.forEach(dong => {
                    if(dong) { // 빈 값이 아닌 경우만 추가
                        const option = document.createElement('option');
                        option.value = dong;
                        option.textContent = dong;
                        dongFilter.appendChild(option);
                    }
                });

                // 필터 이벤트 적용 (변경될 때마다 렌더링 함수 호출)
                dongFilter.addEventListener('change', (e) => {
                    const selectedDong = e.target.value;
                    let filteredData = globalData;
                    
                    if (selectedDong !== '전체') {
                        filteredData = globalData.filter(item => item["법정동"] === selectedDong);
                    }
                    
                    renderDashboard(filteredData);
                });

                // 초기 대시보드 렌더링 (전체 데이터)
                renderDashboard(globalData);

                // 화면 표시 전환
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content').classList.remove('hidden');

            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('loading').innerHTML = `
                    <p class="text-red-500 font-bold">데이터를 불러오는 중 오류가 발생했습니다.</p>
                    <p class="text-sm text-gray-500 mt-2">${error.message}</p>
                `;
            }
        }

        // 페이지 로드 시 시작
        window.onload = initDashboard;
    </script>
</body>
</html>
